<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Üç Görseli DİKEY Birleştir → Tek PNG (1212x2061, 6px çerçeve, cache-bust)</title>
<style>
  :root { --bg:#0b0b0c; --card:#141418; --muted:#8b8b94; --text:#eaeaf0; --accent:#4cc3ff; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:980px;margin:40px auto;padding:20px}
  .card{background:var(--card);border-radius:16px;box-shadow:0 6px 20px #0006;padding:18px;}
  button{width:100%;padding:10px;border-radius:10px;border:1px solid #2a2a32;background:#0f0f13;color:var(--text)}
  button.primary{background:var(--accent);border:0;color:#001018;font-weight:700;cursor:pointer}
  .actions{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  .hint{color:#a7a7b3;font-size:12px}
  canvas{width:100%;max-height:80vh;background:#000;border-radius:12px}
  .error{background:#3a1014;border:1px solid #7a1f29;color:#ffc9cf;padding:10px;border-radius:10px;margin-top:10px}
  .success{background:#0f2c1a;border:1px solid #195f39;color:#c9ffdc;padding:10px;border-radius:10px;margin-top:10px}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#0f2c1a;border:1px solid #195f39;color:#c9ffdc;font-size:12px;font-weight:700}
</style>
</head>
<body>
<div class="wrap">
  <h2>Üç Görseli <span class="badge">DİKEY</span> Birleştir → Tek PNG (1212×2061)</h2>

  <div class="card">
    <div class="actions">
      <button id="mergeBtn" class="primary">Birleştir</button>
      <button id="refreshBtn">Tümünü Yenile</button>
      <button id="downloadBtn" disabled>PNG Olarak İndir</button>
    </div>

    <div id="msg" class="hint" style="margin-top:8px"></div>

    <div style="margin-top:14px">
      <canvas id="cnv"></canvas>
    </div>
  </div>

  <p class="hint">
    Not: Çıktı ölçüsü her zaman <b>1212x2061</b> px olacak şekilde sabitlenmiştir. Görseller arasında ve etrafında 6px siyah çerçeve vardır.
    Görseller her yüklemede <i>cache-bust</i> uygulanır; böylece kaynak sunucu görüntüyü güncellediyse burada da yenilenir.
  </p>
</div>

<script>
// Kaynak URL'ler (koda gömülü)
const URLS = [
  "https://lh3.googleusercontent.com/d/1fwwmFufEMJl-QzUEzsUlGwNN42cpboac?t=1755590336917",
  "https://lh3.googleusercontent.com/d/1Mms77ohqSCYBAohZd-LhJV0fPryLk_oV?t=1755590411754",
  "https://mobesekamerasi.com/kameralar/ipsala2.jpg?ts=1753727561&t=1755590420226"
];

const $ = sel => document.querySelector(sel);
const cnv = $('#cnv');
const ctx = cnv.getContext('2d');
const msgBox = $('#msg');

// Tüm resimleri proxy ile al (CORS güvenli). Cache-bust için her isteğe benzersiz 'cb' ekle.
const PROXY = "https://images.weserv.nl/?url=";
const proxify = (u, cb) => PROXY + encodeURIComponent(u) + "&cb=" + cb;

const FRAME = 6;        // 6px siyah çerçeve
const OUT_W = 1212;     // sabit çıktı
const OUT_H = 2061;

function showMsg(html, type=''){ msgBox.innerHTML = html; msgBox.className = type ? type : 'hint'; }

function loadImg(url, cbToken){
  return new Promise(ok=>{
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.decoding = "async";
    img.loading = "eager";
    img.onload = ()=> ok({ ok:true, img, url });
    img.onerror = ()=> ok({ ok:false, img:null, url });
    img.src = proxify(url, cbToken);
  });
}

async function merge(){
  showMsg("Yükleniyor...");
  cnv.width = OUT_W; cnv.height = OUT_H;

  // Her yüklemede farklı bir cache-bust değeri kullan
  const cbToken = Date.now().toString() + Math.random().toString(36).slice(2);
  const results = await Promise.all(URLS.map(u => loadImg(u, cbToken)));

  // Başarısız olanlara placeholder
  const fixed = results.map(r => {
    if (r.ok) return r;
    const ph = document.createElement('canvas');
    ph.width = 640; ph.height = 360;
    const pctx = ph.getContext('2d');
    pctx.fillStyle = '#d9d9d9'; pctx.fillRect(0,0,ph.width,ph.height);
    pctx.fillStyle = '#555'; pctx.font = 'bold 24px system-ui';
    const txt = 'Yüklenemedi';
    const mt = pctx.measureText(txt);
    pctx.fillText(txt, (ph.width - mt.width)/2, (ph.height/2)+8);
    const img = new Image();
    img.src = ph.toDataURL('image/png');
    return { ok:true, img, url: r.url };
  });

  // Arka plan
  ctx.fillStyle = "#000"; ctx.fillRect(0,0,OUT_W,OUT_H);

  // Dikeyde üç eşit bölge içine, orantıyı koruyarak yerleştir + 6px siyah çerçeve
  const partHeight = Math.floor(OUT_H / fixed.length);
  for (let i=0;i<fixed.length;i++){
    const img = fixed[i].img;
    const scale = Math.min((OUT_W - 2*FRAME)/img.width, (partHeight - 2*FRAME)/img.height);
    const w = Math.round(img.width * scale);
    const h = Math.round(img.height * scale);
    const x = Math.floor((OUT_W - w)/2);
    const y = i*partHeight + Math.floor((partHeight - h)/2);
    ctx.fillStyle = "#000";
    ctx.fillRect(x - FRAME, y - FRAME, w + 2*FRAME, h + 2*FRAME); // çerçeve
    ctx.drawImage(img, x, y, w, h);
  }

  showMsg(`Hazır! ${OUT_W}×${OUT_H} px (cb uygulanmış)`, "success");
  $('#downloadBtn').disabled = false;
}

function download(){
  const url = cnv.toDataURL('image/png');
  const a = document.createElement('a');
  const stamp = new Date().toISOString().replaceAll(':','-').split('.')[0];
  a.href = url; a.download = `birlesik_dikey_${OUT_W}x${OUT_H}_cb_${stamp}.png`;
  document.body.appendChild(a); a.click(); a.remove();
}

$('#mergeBtn').addEventListener('click', merge);
$('#refreshBtn').addEventListener('click', merge);
$('#downloadBtn').addEventListener('click', download);
merge();
</script>
</body>
</html>
